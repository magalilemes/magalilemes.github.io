<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="All aboard"><title>Train of thought writing test cases for Linux kernel's AMDGPU with KUnit</title><link rel=canonical href=https://magalilemes.github.io/posts/defect-testing/><link rel=stylesheet href=/scss/style.min.fe253589db5a54c99fe6b16bfbaf0243d856d34f8c07f3534613b39ed043b738.css><meta property="og:title" content="Train of thought writing test cases for Linux kernel's AMDGPU with KUnit"><meta property="og:description" content="All aboard"><meta property="og:url" content="https://magalilemes.github.io/posts/defect-testing/"><meta property="og:site_name" content="Magali's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2022-08-08T00:00:00-03:00"><meta property="article:modified_time" content="2022-08-08T00:00:00-03:00"><meta name=twitter:title content="Train of thought writing test cases for Linux kernel's AMDGPU with KUnit"><meta name=twitter:description content="All aboard"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üêº</span></figure><div class=site-meta><h1 class=site-name><a href=/>Magali's Blog</a></h1><h2 class=site-description>BSc Computer Science student</h2></div></header><ol class=social-menu><li><a href=https://github.com/magalilemes target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://gitlab.com/magalilemes target=_blank title=GitLab><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-gitlab" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M21 14l-9 7-9-7L6 3l3 7h6l3-7z"/></svg></a></li><li><a href=https://linkedin.com/in/magalilemes target=_blank title=LinkedIn><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>$HOME</span></a></li><li><a href=/whoami/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>whoami</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/defect-testing/>Train of thought writing test cases for Linux kernel's AMDGPU with KUnit</a></h2><h3 class=article-subtitle>All aboard</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 08, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p>There are many ways to approach writing test cases, one of them being writing
test cases that cover discovered bugs. In this post, I&rsquo;ll walk through my train
of thoughts into writing one test case for a bug in the Linux kernel&rsquo;s AMDGPU
Display Mode Library.</p><h1 id=background-story>Background story</h1><p>The file of interest here is located inside the Linux kernel repository at
<code>drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c</code>. To try and understand
the approach into building the test case, take a look at the <a class=link href="https://patchwork.freedesktop.org/patch/488777/?series=104903&rev=1" target=_blank rel=noopener>patch series that
fixes the
issue</a>.</p><p>Before commit <code>8861c27a</code>, the function <code>dcn21_update_bw_bounding_box</code> worked
fine, but its 2192-byte frame size triggered a warning for exceeding the stack
size that could be used. An attempt to fix this problem is made by commit
<code>8861c27a</code>, which removes a very large variable from the function. Although this
solution does fix the stack size problem, the new version of
<code>dcn21_update_bw_bounding_box</code> is not functionally equivalent to the old one.
Then comes commit <code>9ad5d02c</code> tackling the two previous issues: the stack size no
longer exceeds the specified limit, and <code>dcn21_update_bw_bounding_box</code> now
presents the same behavior as it did before <code>8861c27a</code>.</p><h1 id=setup-and-playing-a-bit>Setup and playing a bit</h1><p>To get a grasp of what was accomplished, it could be desirable to clone the
repository and play around a bit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone --branch blog-post-03 https://github.com/magalilemes/linux.git
</span></span></code></pre></div><p>Then navigate into the directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> linux
</span></span></code></pre></div><p>Run the command below to run all KUnit&rsquo;s AMDGPU tests, they are all expected to
run successfully:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./tools/testing/kunit/kunit.py run --arch<span class=o>=</span>x86_64 --kunitconfig<span class=o>=</span>drivers/gpu/drm/amd/display/tests
</span></span></code></pre></div><p>Roll back <code>drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c</code> to the commit
version that introduced the issue:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git checkout 8861c27a -- drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c
</span></span></code></pre></div><p>When running the KUnit tests again, it is natural and expected that the test
will fail:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./tools/testing/kunit/kunit.py run --arch<span class=o>=</span>x86_64 --kunitconfig<span class=o>=</span>drivers/gpu/drm/amd/display/tests
</span></span></code></pre></div><p>Roll back <code>drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c</code> to a point
before the problematic commit was introduced:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git checkout 8861c27a^ -- drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c
</span></span></code></pre></div><p>Finally run the KUnit tests again, and notice that they all pass:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./tools/testing/kunit/kunit.py run --arch<span class=o>=</span>x86_64 --kunitconfig<span class=o>=</span>drivers/gpu/drm/amd/display/tests
</span></span></code></pre></div><h1 id=writing-a-test-case-for-dcn21_update_bw_bounding_box>Writing a test case for dcn21_update_bw_bounding_box</h1><p>The task at hand is to write a test case that fails when the file of the
function to be tested is at version <code>8861c27a</code>. Run the command below to have
only <code>dcn20_fpu.c</code> at that version.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git checkout 8861c27a -- drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c
</span></span></code></pre></div><p>If everything worked correctly, the function below is the same as the one in
<code>dcn20_fpu.c</code>. Now, the next step is getting a gist of the function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dcn21_update_bw_bounding_box</span><span class=p>(</span><span class=k>struct</span> <span class=n>dc</span> <span class=o>*</span><span class=n>dc</span><span class=p>,</span> <span class=k>struct</span> <span class=n>clk_bw_params</span> <span class=o>*</span><span class=n>bw_params</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>dcn21_resource_pool</span> <span class=o>*</span><span class=n>pool</span> <span class=o>=</span> <span class=nf>TO_DCN21_RES_POOL</span><span class=p>(</span><span class=n>dc</span><span class=o>-&gt;</span><span class=n>res_pool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>clk_limit_table</span> <span class=o>*</span><span class=n>clk_table</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>bw_params</span><span class=o>-&gt;</span><span class=n>clk_table</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>closest_clk_lvl</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>dc_assert_fp_enabled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_ip</span><span class=p>.</span><span class=n>max_num_otg</span> <span class=o>=</span> <span class=n>pool</span><span class=o>-&gt;</span><span class=n>base</span><span class=p>.</span><span class=n>res_cap</span><span class=o>-&gt;</span><span class=n>num_timing_generator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_ip</span><span class=p>.</span><span class=n>max_num_dpp</span> <span class=o>=</span> <span class=n>pool</span><span class=o>-&gt;</span><span class=n>base</span><span class=p>.</span><span class=n>pipe_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_chans</span> <span class=o>=</span> <span class=n>bw_params</span><span class=o>-&gt;</span><span class=n>num_channels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>ASSERT</span><span class=p>(</span><span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Copy dcn2_1_soc.clock_limits to clock_limits to avoid copying over null states later */</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* loop backwards*/</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=n>closest_clk_lvl</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>dcfclk_mhz</span> <span class=o>&lt;=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>dcfclk_mhz</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>closest_clk_lvl</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* clk_table[1] is reserved for min DF PState.  skip here to fill in later. */</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dcfclk_mhz</span> <span class=o>=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>dcfclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>fabricclk_mhz</span> <span class=o>=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>socclk_mhz</span> <span class=o>=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>socclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dram_speed_mts</span> <span class=o>=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>memclk_mhz</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dispclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dispclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dppclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dppclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dscclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dscclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dtbclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dtbclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>=</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* fill in min DF PState */</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=nf>construct_low_pstate_lvl</span><span class=p>(</span><span class=n>clk_table</span><span class=p>,</span> <span class=n>closest_clk_lvl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* duplicate last level */</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span><span class=p>]</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>dml_init_instance</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dc</span><span class=o>-&gt;</span><span class=n>dml</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dcn2_1_soc</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dcn2_1_ip</span><span class=p>,</span> <span class=n>DML_PROJECT_DCN21</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This function has only two parameters:</p><ul><li><code>struct dc *</code>: a pointer to a Display Core<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> control structure;</li><li><code>struct clk_bw_params *</code>: a pointer to a structure for clocks and bandwidth.</li></ul><p>After the declaration and initialization of variables, <code>dc_assert_fp_enabled</code> is
called to ensure that the function is being executed under FPU protection, as it
is about to perform some floating point operations. Then some values from the
global variable <code>dcn2_1_ip</code> are updated based on the provided parameters.
Finally, before the first loop begins, it is assured that the clock table from
<code>struct clk_bw_params</code> has at least one entry.</p><p>In the first loop, an odd thing happens:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Copy dcn2_1_soc.clock_limits to clock_limits to avoid copying over null states later */</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It seems like nothing meaninful is happening, since the elements of the clock
limits array are being set to themselves. At this point, it is useful to go back
and see how the function behaved before <code>8861c27a</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Copy dcn2_1_soc.clock_limits to clock_limits to avoid copying over null states later */</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>num_states</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>That makes more sense, and is coherent with the comment above it. It&rsquo;s important
to notice that commit <code>8861c27a</code> replaced occurences of <code>clock_limits</code> wit
<code>dcn2_1_soc.clock_limits</code>, so that is why the first for loop is like that.</p><h2 id=finding-the-problem>Finding the problem</h2><p>Moving on, there&rsquo;s another loop. Notice its last lines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>[...]</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dispclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dispclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dppclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dppclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dscclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dscclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dtbclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dtbclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Compare with the previous version, which used <code>clock_limits</code> to store the clock
limits values before assigning them to <code>dcn2_1_soc.clock_limits</code> directly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>[...]</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dispclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dispclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dppclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dppclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dram_bw_per_chan_gbps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dscclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dscclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>dtbclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>dtbclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_d18_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clock_limits</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>phyclk_mhz</span> <span class=o>=</span> <span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>closest_clk_lvl</span><span class=p>].</span><span class=n>phyclk_mhz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>clk_table</span><span class=o>-&gt;</span><span class=n>num_entries</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>clock_limits</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span></code></pre></div><p>Now to make it easier to visualize, suppose that before
<code>dcn21_update_bw_bounding_box</code> is called, some values from
<code>dcn2_1_soc.clock_limits</code> are as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>2</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>757.89</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>3</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>847.06</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>4</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>900.00</span><span class=p>;</span>
</span></span></code></pre></div><p><strong>Now after invoking <code>dcn21_update_bw_bounding_box</code>, what happens with the
values of <code>dcn2_1_soc.clock_limits[k].dispclk</code> for k = 3, closest_clk_lvl = 2;
and for k = 4, closest_clk_lvl = 3?</strong></p><ul><li><p>Previous version (8861c27a^): * <code>clock_limits[3].dispclk_mhz</code> is set to
<code>dcn2_1_soc.clock_limits[2].dispclk_mhz</code>; * then
<code>clock_limits[4].dispclk_mhz</code> is set to
<code>dcn2_1_soc.clock_limits[3].dispclk_mhz</code>.</p><p>After the end of the loop, <code>clock_limits</code> is copied onto
<code>dcn2_1_soc.clock_limits</code>, resulting in:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>3</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>757.89</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>4</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>847.06</span><span class=p>;</span>
</span></span></code></pre></div><ul><li><p>Problematic version (8861c27a): * <code>dcn2_1_soc.clock_limits[3].dispclk_mhz</code> is
set to <code>dcn2_1_soc.clock_limits[2].dispclk_mhz</code>; * then in the next
iteration, <code>dcn2_1_soc.clock_limits[4].dispclk_mhz</code> is set to
<code>dcn2_1_soc.clock_limits[3].dispclk_mhz</code>.</p><p>After the end of the loop, this is the result:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>3</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>757.89</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>dcn2_1_soc</span><span class=p>.</span><span class=n>clock_limits</span><span class=p>[</span><span class=mi>4</span><span class=p>].</span><span class=n>dispclk</span> <span class=o>=</span> <span class=mf>757.89</span><span class=p>;</span>
</span></span></code></pre></div><p>The part to pay attention here is that by dropping the intermediate variable,
<code>dcn2_1_soc.clock_limits</code> ends up being overwritten by itself, and some values
that it stored may be lost in the way.</p><h2 id=building-the-test-case>Building the test case</h2><p>After understanding where the problem lays, it is time to write a test case that
covers it.</p><p>The function parameters will be as simple as possible, only the necessary struct
members will have their values set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>.</span><span class=n>dc</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>res_pool</span> <span class=o>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=k>struct</span> <span class=n>resource_pool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=n>pipe_count</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=n>res_cap</span> <span class=o>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=k>struct</span> <span class=n>resource_caps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>.</span><span class=n>num_timing_generator</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>bw_params.clk_table.entries[]</code> values will be set in a way so that a situation
where (k = 3, closest_clk_lvl = 2) and (k = 4, closest_clk_lvl = 3) will be
created, closely following what was discussed above.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>.</span><span class=n>bw_params</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>num_channels</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>clk_table</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=n>entries</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>voltage</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dcfclk_mhz</span> <span class=o>=</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>fclk_mhz</span> <span class=o>=</span> <span class=mi>400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>memclk_mhz</span> <span class=o>=</span> <span class=mi>800</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>socclk_mhz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>voltage</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dcfclk_mhz</span> <span class=o>=</span> <span class=mi>201</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>fclk_mhz</span> <span class=o>=</span> <span class=mi>800</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>memclk_mhz</span> <span class=o>=</span> <span class=mi>1600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>socclk_mhz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>voltage</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dcfclk_mhz</span> <span class=o>=</span> <span class=mi>553</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>fclk_mhz</span> <span class=o>=</span> <span class=mi>1067</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>memclk_mhz</span> <span class=o>=</span> <span class=mi>1067</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>socclk_mhz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>voltage</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dcfclk_mhz</span> <span class=o>=</span> <span class=mi>602</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>fclk_mhz</span> <span class=o>=</span> <span class=mi>1333</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>memclk_mhz</span> <span class=o>=</span> <span class=mi>1600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>socclk_mhz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>voltage</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dispclk_mhz</span> <span class=o>=</span> <span class=mi>1372</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dppclk_mhz</span> <span class=o>=</span> <span class=mi>1372</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>phyclk_mhz</span> <span class=o>=</span> <span class=mi>810</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>phyclk_d18_mhz</span> <span class=o>=</span> <span class=mi>667</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>dtbclk_mhz</span> <span class=o>=</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=n>num_entries</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>dcn2_1_soc</code> is a global variable, and its original values will be used for this
test case, so no need to set it differently.</p><p>After having the function input, the next step is building the expected values.
For this test case, <code>dcn2_1_soc</code> is the one expected to change. One easy way (is
it the right one, though?) to obtain the expected values is running the function
when it is in its correct state, and seeing what was yielded. Finally, one test
case is ready: it is now time to think about other ways to write others.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a class=link href=https://www.kernel.org/doc/html/latest/gpu/amdgpu/display/index.html target=_blank rel=noopener>drm/amd/display - Display Core
(DC)</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2022 Magali's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>